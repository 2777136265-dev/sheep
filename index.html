<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¸ªäººå­¦ä¹ ä¸»é¡µ | å¤§å­¦ç”Ÿ</title>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        a {
            text-decoration: none;
            color: inherit;
        }
        button {
            cursor: pointer;
            border: none;
            background: none;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        /* å¯¼èˆªæ æ ·å¼ - æ ¸å¿ƒè°ƒæ•´ï¼šç™»å½•å…¥å£ç§»åˆ°å³ä¸Šè§’ */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ï¼Œå®ç°ç™»å½•å…¥å£å³å¯¹é½ */
            align-items: center;
            padding: 0 20px;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        /* å¯¼èˆªé“¾æ¥åŒºåŸŸ */
        .nav-links {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .nav-links a {
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .nav-links a:hover {
            background-color: #34495e;
        }
        /* ç™»å½•/ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼ˆå³ä¸Šè§’ï¼‰ */
        .auth-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .auth-btn {
            background-color: #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .auth-btn:hover {
            background-color: #2980b9;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }
        /* æ–°å¢ï¼šåœ†å½¢å¤´åƒæ ·å¼ */
        .user-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #3498db;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .user-avatar-small:hover {
            transform: scale(1.1);
        }
        .sign-btn {
            background-color: #e67e22;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .sign-btn:hover {
            background-color: #d35400;
        }
        .sign-btn.disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        /* ä¸ªäººä»‹ç»æ ·å¼ */
        .profile {
            display: flex;
            align-items: center;
            gap: 30px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 40px;
        }
        .profile-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid #ecf0f1;
        }
        .profile-info h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .profile-info p {
            margin-bottom: 10px;
            color: #666;
        }
        .tag {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            margin-right: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        /* å­¦ä¹ èµ„æ–™æ ·å¼ */
        .materials {
            margin-bottom: 40px;
        }
        .materials h2 {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: #2c3e50;
            border-left: 5px solid #3498db;
            padding-left: 15px;
        }
        .material-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .material-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        .material-card:hover {
            transform: translateY(-5px);
        }
        .material-card h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .material-card p {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .material-card a {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .material-card a:hover {
            background-color: #2980b9;
        }
        /* è”ç³»æ–¹å¼æ ·å¼ - ä¿®æ­£å¸ƒå±€å’Œæ ‡ç­¾é”™è¯¯ */
        .contact {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 40px;
        }
        .contact h2 {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: #2c3e50;
            border-left: 5px solid #3498db;
            padding-left: 15px;
        }
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .contact-item {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
        }
        .contact-item i {
            color: #3498db;
            font-size: 1.2rem;
            width: 24px; /* å›ºå®šå›¾æ ‡å®½åº¦ï¼Œå¯¹é½æ›´æ•´é½ */
            text-align: center;
        }
        /* é¡µè„šæ ·å¼ */

        footer {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 40px;
        }
        footer p {
            font-size: 1rem;
        }
        /* å“åº”å¼æ ·å¼ - é€‚é…æ‰‹æœºç«¯ */
        @media (max-width: 768px) {
            .profile {
                flex-direction: column;
                text-align: center;
            }
            .nav-container {
                flex-direction: column;
                gap: 15px;
            }
            .nav-links, .auth-area {
                flex-wrap: wrap;
                justify-content: center;
            }
            .contact-item {
                font-size: 1rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- å¯¼èˆªæ  - ä¿®å¤ç»“æ„é”™è¯¯ï¼Œæ–°å¢ç•™è¨€æ¿å…¥å£å’Œå¤´åƒæ˜¾ç¤º -->
    <header>
        <div class="nav-container">
            <div class="logo">æˆ‘çš„å­¦ä¹ ä¸»é¡µ</div>
            
            <!-- å¯¼èˆªé“¾æ¥åŒºåŸŸï¼ˆä¿®å¤åŸæœ‰é”™è¯¯ï¼šç§»é™¤å¤šä½™liæ ‡ç­¾ï¼Œæ•´åˆç•™è¨€æ¿å…¥å£ï¼‰ -->
            <div class="nav-links">
                <a href="#profile">ä¸ªäººä»‹ç»</a>
                <a href="#materials">å­¦ä¹ èµ„æ–™</a>
                <a href="#contact">è”ç³»æ–¹å¼</a>
                <!-- ç•™è¨€æ¿å…¥å£ï¼ˆæ­£ç¡®æ•´åˆåˆ°å¯¼èˆªé“¾æ¥ä¸­ï¼‰ -->
                <a href="message-board.html" class="hover-primary" style="display: flex; align-items: center;">
                    <<i class="fa fa-comments-o mr-1"></</i> ç•™è¨€æ¿
                </a>
                <a href="admin.html" id="admin-link" style="display: none;">ç®¡ç†å‘˜åå°</a>
            </div>
            
            <!-- ç™»å½•/ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼ˆå³ä¸Šè§’ï¼‰- æ–°å¢å¤´åƒæ˜¾ç¤º -->
            <div class="auth-area">
                <!-- æœªç™»å½•æ˜¾ç¤ºç™»å½•å…¥å£ -->
                <div id="auth-entrance" style="display: block;">
                    <a href="login.html" class="auth-btn">ç™»å½•/æ³¨å†Œ</a>
                </div>
                <!-- ç™»å½•åæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆæ–°å¢å¤´åƒï¼‰ -->
                <div id="user-area" class="user-info" style="display: none;">
                    <!-- æ–°å¢ï¼šç”¨æˆ·åœ†å½¢å¤´åƒ -->
                    <img src="" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar-small" id="nav-avatar">
                    <span>ğŸ‘¤ <span id="username">ç”¨æˆ·å</span></span>
                    <span>ç§¯åˆ†ï¼š<span id="points">0</span> âœ¨</span>
                    <button class="sign-btn" id="sign-btn">ä»Šæ—¥ç­¾åˆ°</button>
                    <button class="auth-btn" id="logout-btn">é€€å‡º</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="container" id="main-container">
        <!-- ä¸ªäººä»‹ç» -->
        <section class="profile" id="profile">
            <img src="http://q1.qlogo.cn/g?b=qq&nk=2777136265&s=100" alt="ä¸ªäººå¤´åƒ" class="profile-img" id="main-avatar">
            <div class="profile-info">
                <h2>é£ç¿”çš„ç¾Šç¾Š | ç”Ÿæ€å­¦ä¸“ä¸š</h2>
                <p>ğŸ‘‹ å¤§å®¶å¥½ï¼æˆ‘æ˜¯ä¸€åå¤§äºŒå­¦ç”Ÿï¼Œçƒ­çˆ±å­¦ä¹ å’Œåˆ†äº«ï¼Œå¸Œæœ›é€šè¿‡è¿™ä¸ªä¸»é¡µå’Œå¤§å®¶äº¤æµå­¦ä¹ å¿ƒå¾—ï¼Œå…±äº«ä¼˜è´¨å­¦ä¹ èµ„æºï½</p>
                <p>ğŸ“š æ“…é•¿é¢†åŸŸï¼šæ— </p>
                <p>ğŸ¯ è¿‘æœŸç›®æ ‡ï¼šæ— </p>
                <div>
                    <span class="tag">ç”Ÿæ€ä¸“ä¸š</span>
                    <span class="tag">å­¦ä¹ åˆ†äº«</span>
                    <span class="tag">å‰ç«¯å¼€å‘</span>
                    <span class="tag">ç®—æ³•åˆ·é¢˜</span>
                </div>
            </div>
        </section>

        <!-- å­¦ä¹ èµ„æ–™åˆ†äº« -->
        <section class="materials" id="materials">
            <h2>ğŸ“– å­¦ä¹ èµ„æ–™åˆ†äº«</h2>
            <div class="material-list">
                <div class="material-card">
                    <h3>å­¦ä¹ èµ„æ–™åˆ†äº«</h3>
                    <p>åŒ…å«ç”Ÿç‰©åŒ–å­¦ã€åŠ¨ç‰©å­¦ç­‰æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œé™„åˆ·é¢˜æ€è·¯å’Œä¾‹é¢˜è§£æ</p>
                    <a href="https://pan.baidu.com/s/1739wCLzmLSAdvMsW3vzdPw?pwd=5xq9" target="_blank">ä¸‹è½½PDF</a>
                </div>
                <div class="material-card">
                    <h3>Pythonå…¥é—¨åˆ°å®æˆ˜æ•™ç¨‹</h3>
                    <p>é€‚åˆé›¶åŸºç¡€ï¼Œæ¶µç›–åŸºç¡€è¯­æ³•ã€çˆ¬è™«ã€æ•°æ®åˆ†æã€å°é¡¹ç›®å®æˆ˜ï¼ˆé™„æºç ï¼‰</p>
                    <a href="#" target="_blank">æŸ¥çœ‹æ•™ç¨‹</a>
                </div>
                <div class="material-card">
                    <h3>å‰ç«¯é¢è¯•é«˜é¢‘è€ƒç‚¹æ•´ç†</h3>
                    <p>HTML/CSS/JSæ ¸å¿ƒè€ƒç‚¹ã€æµè§ˆå™¨åŸç†ã€æ¡†æ¶é¢è¯•é¢˜ï¼Œé™„å‚è€ƒç­”æ¡ˆ</p>
                    <a href="#" target="_blank">è·å–èµ„æ–™</a>
                </div>
                <div class="material-card">
                    <h3>è“æ¡¥æ¯å†å¹´çœŸé¢˜åŠè§£æ</h3>
                    <p>è¿‘5å¹´è“æ¡¥æ¯çœèµ›/å›½èµ›çœŸé¢˜ï¼ŒåŒ…å«C++/Pythonä¸¤ç§è§£æ³•ï¼Œé™„è¯„åˆ†æ ‡å‡†</p>
                    <a href="#" target="_blank">ä¸‹è½½çœŸé¢˜</a>
                </div>
            </div>
        </section>

        <!-- è”ç³»æ–¹å¼ - ä¿®æ­£HTMLæ ‡ç­¾é”™è¯¯ -->
        <section class="contact" id="contact">
            <h2>ğŸ“ è”ç³»æ–¹å¼</h2>
            <div class="contact-info">
                <div class="contact-item">
                    <<i class="fas fa-envelope"></</i>
                    <span>é‚®ç®±ï¼š2777136265@qq.com</span>
                </div>
                <div class="contact-item">
                    <<i class="fas fa-wechat"></</i>
                    <span>å¾®ä¿¡ï¼šfly_sheep1ï¼ˆå¤‡æ³¨ï¼šå­¦ä¹ äº¤æµï¼‰</span>
                </div>
                <div class="contact-item">
                    <<i class="fas fa-github"></</i>
                    <span>GitHubï¼šgithub.com/ä½ çš„ç”¨æˆ·å</span>
                </div>
                <div class="contact-item">
                    <<i class="fas fa-qq"></</i>
                    <span>QQï¼š2777136265</span>
                </div>
            </div>
        </section>
    </div>

    <!-- é¡µè„š -->
    <footer>
        <p>Â© 2025 æˆ‘çš„ä¸ªäººå­¦ä¹ ä¸»é¡µ | å¤§å­¦ç”Ÿå­¦ä¹ åˆ†äº«å¹³å°</p>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">æ„¿æˆ‘ä»¬éƒ½åœ¨å­¦ä¹ çš„è·¯ä¸Šä¸æ–­è¿›æ­¥ï½</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== Supabaseæ ¸å¿ƒé…ç½®ï¼ˆæ›¿æ¢ä¸ºä½ çš„ï¼ï¼‰====================
        const SUPABASE_URL = 'https://neflfdfpzyjookonmleo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZmxmZGZwenlqb29rb25tbGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNzQxMTUsImV4cCI6MjA4MDk1MDExNX0.z944F1VmJO9ro-1iDtB9HD_1NVThzz7mzqSX0IQqj68';
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // å…¨å±€å˜é‡ï¼šå­˜å‚¨å½“å‰ç”¨æˆ·ï¼ˆé¿å…é‡å¤æŸ¥è¯¢ï¼‰
        let currentUser = null;

        // é¡µé¢åŠ è½½åæ‰§è¡Œ
        window.onload = async function() {
            await checkLoginStatus(); // æ£€æŸ¥ç™»å½•çŠ¶æ€
            bindLogoutEvent(); // ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶
            // å…³é”®ä¿®å¤ï¼šå°†ç­¾åˆ°äº‹ä»¶ç»‘å®šå»¶è¿Ÿåˆ°ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆåï¼Œä¸”ç›´æ¥ç»‘å®šåˆ°æŒ‰é’®å…ƒç´ 
            if (currentUser) {
                bindSignEvent(); // å·²ç™»å½•æ—¶ç»‘å®šç­¾åˆ°äº‹ä»¶
            }
        };

        // ==================== æ£€æŸ¥ç™»å½•çŠ¶æ€ ====================
        async function checkLoginStatus() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                const authEntrance = document.getElementById('auth-entrance');
                const userArea = document.getElementById('user-area');
                const signBtn = document.getElementById('sign-btn');

                if (session) {
                    // å·²ç™»å½•ï¼šæ˜¾ç¤ºç”¨æˆ·åŒºåŸŸï¼Œéšè—ç™»å½•å…¥å£
                    currentUser = session.user; // å­˜å‚¨å½“å‰ç”¨æˆ·
                    authEntrance.style.display = 'none';
                    userArea.style.display = 'flex';
                    await renderUserInfo(session.user.id, session.user.email);
                    // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²ç­¾åˆ°
                    await checkSignStatus();
                    // ç¡®ä¿ç­¾åˆ°æŒ‰é’®äº‹ä»¶å·²ç»‘å®šï¼ˆåŒé‡ä¿é™©ï¼‰
                    if (!signBtn.onclick) {
                        bindSignEvent();
                    }
                } else {
                    // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•å…¥å£ï¼Œéšè—ç”¨æˆ·åŒºåŸŸ
                    currentUser = null;
                    authEntrance.style.display = 'block';
                    userArea.style.display = 'none';
                }
            } catch (err) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥ï¼š', err);
                alert('ç™»å½•çŠ¶æ€æ£€æµ‹å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        }

        // ==================== æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯ï¼ˆæ–°å¢å¤´åƒæ¸²æŸ“ï¼‰====================
        async function renderUserInfo(userId, userEmail) {
            try {
                const { data: userProfile, error } = await supabase
                    .from('users')
                    .select('username, points')
                    .eq('id', userId)
                    .single();

                if (error) throw new Error('æœªæŸ¥è¯¢åˆ°ç”¨æˆ·ä¿¡æ¯');

                // æ›´æ–°é¡µé¢ä¸Šçš„ç”¨æˆ·åå’Œç§¯åˆ†
                document.getElementById('username').textContent = userProfile.username;
                document.getElementById('points').textContent = userProfile.points || 0;

                // æ–°å¢ï¼šè·å–QQå¤´åƒï¼ˆä»é‚®ç®±æå–QQå·ï¼‰
                if (userEmail && userEmail.includes('@qq.com')) {
                    const qqNumber = userEmail.split('@')[0];
                    const avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${qqNumber}&s=640`;
                    // æ›´æ–°å¯¼èˆªæ å°å¤´åƒ
                    document.getElementById('nav-avatar').src = avatarUrl;
                    document.getElementById('nav-avatar').alt = `${userProfile.username}çš„å¤´åƒ`;
                    // å¯é€‰ï¼šæ›´æ–°ä¸»é¡µå¤§å¤´åƒ
                    document.getElementById('main-avatar').src = avatarUrl;
                }
            } catch (err) {
                console.error('æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š', err);
                document.getElementById('username').textContent = 'æœªçŸ¥ç”¨æˆ·';
            }
        }

        // ==================== æ£€æŸ¥ä»Šæ—¥ç­¾åˆ°çŠ¶æ€ ====================
        async function checkSignStatus() {
            try {
                if (!currentUser) return;

                const today = new Date().toISOString().split('T')[0]; // ä»Šæ—¥æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
                const signBtn = document.getElementById('sign-btn');

                // æŸ¥è¯¢ç”¨æˆ·ä»Šæ—¥ç­¾åˆ°è®°å½•ï¼ˆéœ€å…ˆåˆ›å»ºsign_recordsè¡¨ï¼‰
                const { data: signRecord } = await supabase
                    .from('sign_records')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('sign_date', today)
                    .single();

                if (signRecord) {
                    // å·²ç­¾åˆ°ï¼šç¦ç”¨ç­¾åˆ°æŒ‰é’®
                    signBtn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
                    signBtn.classList.add('disabled');
                    signBtn.disabled = true;
                } else {
                    // æœªç­¾åˆ°ï¼šå¯ç”¨ç­¾åˆ°æŒ‰é’®
                    signBtn.textContent = 'ä»Šæ—¥ç­¾åˆ°';
                    signBtn.classList.remove('disabled');
                    signBtn.disabled = false;
                }
            } catch (err) {
                // æ— ç­¾åˆ°è®°å½•è¡¨æˆ–æœªç­¾åˆ°ï¼Œé»˜è®¤æ˜¾ç¤ºå¯ç­¾åˆ°
                const signBtn = document.getElementById('sign-btn');
                signBtn.textContent = 'ä»Šæ—¥ç­¾åˆ°';
                signBtn.classList.remove('disabled');
                signBtn.disabled = false;
            }
        }

        // ==================== ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶ ====================
        function bindLogoutEvent() {
            const logoutBtn = document.getElementById('logout-btn');
            logoutBtn.onclick = async function() {
                try {
                    await supabase.auth.signOut();
                    alert('é€€å‡ºç™»å½•æˆåŠŸï¼');
                    window.location.reload(); // åˆ·æ–°é¡µé¢
                } catch (err) {
                    alert('é€€å‡ºç™»å½•å¤±è´¥ï¼š' + err.message);
                }
            };
        }

        // ==================== ç»‘å®šç­¾åˆ°äº‹ä»¶ï¼ˆæ ¸å¿ƒä¿®å¤ï¼ï¼‰====================
        function bindSignEvent() {
            const signBtn = document.getElementById('sign-btn');
            // ç›´æ¥ç»™æŒ‰é’®ç»‘å®šonclickäº‹ä»¶ï¼ˆé¿å…äº‹ä»¶å§”æ‰˜å¤±æ•ˆï¼‰
            signBtn.onclick = async function() {
                try {
                    if (!currentUser) {
                        alert('è¯·å…ˆç™»å½•ï¼');
                        window.location.href = 'login.html';
                        return;
                    }

                    // ç¦ç”¨ç­¾åˆ°æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                    signBtn.disabled = true;
                    signBtn.textContent = 'ç­¾åˆ°ä¸­...';

                    // 1. è·å–å½“å‰ç”¨æˆ·ç§¯åˆ†
                    const { data: userProfile, error: userError } = await supabase
                        .from('users')
                        .select('points')
                        .eq('id', currentUser.id)
                        .single();

                    if (userError) throw new Error(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š${userError.message}`);

                    const currentPoints = userProfile.points || 0;
                    const addPoints = 10; // ç­¾åˆ°è·å¾—10ç§¯åˆ†
                    const newPoints = currentPoints + addPoints;

                    // 2. æ›´æ–°ç”¨æˆ·ç§¯åˆ†
                    const { error: updateError } = await supabase
                        .from('users')
                        .update({ points: newPoints })
                        .eq('id', currentUser.id);

                    if (updateError) {
                     console.error('ç§¯åˆ†æ›´æ–°é”™è¯¯è¯¦æƒ…ï¼š', updateError);
                     throw new Error(`ç§¯åˆ†æ›´æ–°å¤±è´¥ï¼š${updateError.message}`);
                    }

                    // 3. è®°å½•ç­¾åˆ°å†å²ï¼ˆå¯é€‰ï¼‰
                    const today = new Date().toISOString().split('T')[0];
                    const { error: insertError } = await supabase.from('sign_records').insert([{
                        user_id: currentUser.id,
                        sign_date: today,
                        points: addPoints
                    }]);

                    if (insertError) console.warn('ç­¾åˆ°è®°å½•æ’å…¥å¤±è´¥ï¼š', insertError);

                    // 4. æ›´æ–°é¡µé¢ç§¯åˆ†å’Œç­¾åˆ°çŠ¶æ€
                    document.getElementById('points').textContent = newPoints;
                    signBtn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
                    signBtn.classList.add('disabled');
                    alert(`ç­¾åˆ°æˆåŠŸï¼è·å¾—${addPoints}ç§¯åˆ†ï¼Œå½“å‰ç§¯åˆ†ï¼š${newPoints}`);

                } catch (err) {
                    alert('ç­¾åˆ°å¤±è´¥ï¼š' + err.message);
                    signBtn.textContent = 'ä»Šæ—¥ç­¾åˆ°';
                    signBtn.disabled = false;
                }
            };
        }
    </script>
</body>
</html>
