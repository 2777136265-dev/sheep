<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人学习主页</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            background-color: #1a1a1a;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #222;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 18px;
            color: #ccc;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info span {
            font-size: 14px;
            color: #999;
        }
        .logout-btn {
            padding: 6px 12px;
            background-color: #f44336;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }
        .login-tip {
            text-align: center;
            margin-top: 100px;
            color: #999;
            font-size: 16px;
        }
        .login-tip a {
            color: #4CAF50;
            text-decoration: none;
            margin: 0 5px;
        }
        .profile-card {
            background-color: #2d2d2d;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        .profile-card h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #ccc;
        }
        .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }
        .profile-item label {
            color: #999;
            font-size: 14px;
        }
        .profile-item span {
            color: #fff;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            margin-top: 100px;
            color: #999;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>个人学习主页</h1>
        <div class="user-info" id="user-info">
            <span>加载中...</span>
        </div>
    </div>

    <div id="main-content">
        <div class="loading">正在获取用户信息...</div>
    </div>

    <script>
        // ==================== Supabase核心配置（替换为你的！）====================
        const SUPABASE_URL = 'https://neflfdfpzyjookonmleo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZmxmZGZwenlqb29rb25tbGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNzQxMTUsImV4cCI6MjA4MDk1MDExNX0.z944F1VmJO9ro-1iDtB9HD_1NVThzz7mzqSX0IQqj68';
        
        // ==================== 全局变量 ====================
        let supabase = null;

        // ==================== 初始化Supabase SDK ====================
        (function loadSupabase() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            
            script.onload = function() {
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('Supabase初始化完成');
                    // 初始化完成后检查登录状态
                    checkLoginStatus();
                } catch (err) {
                    alert('Supabase初始化失败：' + err.message);
                }
            };
            
            script.onerror = function() {
                alert('Supabase SDK加载失败，请检查网络！');
            };
            
            document.head.appendChild(script);
        })();

        // ==================== 检查登录状态 ====================
        async function checkLoginStatus() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                const userInfoEl = document.getElementById('user-info');
                const mainContentEl = document.getElementById('main-content');

                if (session) {
                    // 已登录：展示用户信息和退出按钮
                    userInfoEl.innerHTML = `
                        <span>欢迎：${session.user.email.split('@')[0]}</span>
                        <button class="logout-btn" onclick="handleLogout()">退出登录</button>
                    `;
                    // 获取用户详细信息
                    await getProfile(session.user.id);
                } else {
                    // 未登录：展示登录/注册链接
                    userInfoEl.innerHTML = '<span>未登录</span>';
                    mainContentEl.innerHTML = `
                        <div class="login-tip">
                            请先<a href="login.html">登录</a>或<a href="register.html">注册</a>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('检查登录状态失败：', err);
                document.getElementById('main-content').innerHTML = '<div class="login-tip">获取状态失败，请刷新页面</div>';
            }
        }

        // ==================== 获取用户详细信息 ====================
        async function getProfile(userId) {
            try {
                const { data: userProfile, error } = await supabase
                    .from('users')
                    .select('username, email, points, status')
                    .eq('id', userId)
                    .single();

                const mainContentEl = document.getElementById('main-content');
                if (error) throw new Error('未查询到用户资料');

                // 展示用户资料卡片
                mainContentEl.innerHTML = `
                    <div class="profile-card">
                        <h2>个人资料</h2>
                        <div class="profile-item">
                            <label>用户名：</label>
                            <span>${userProfile.username}</span>
                        </div>
                        <div class="profile-item">
                            <label>邮箱：</label>
                            <span>${userProfile.email}</span>
                        </div>
                        <div class="profile-item">
                            <label>积分：</label>
                            <span>${userProfile.points}</span>
                        </div>
                        <div class="profile-item">
                            <label>账号状态：</label>
                            <span>${userProfile.status === 1 ? '正常' : '禁用'}</span>
                        </div>
                    </div>
                `;
            } catch (err) {
                document.getElementById('main-content').innerHTML = `<div class="login-tip">${err.message}</div>`;
            }
        }

        // ==================== 退出登录 ====================
        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                alert('退出登录成功！');
                window.location.reload();
            } catch (err) {
                alert('退出登录失败：' + err.message);
            }
        }
    </script>
</body>
</html>
