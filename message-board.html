<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€ - æˆ‘çš„å­¦ä¹ ä¸»é¡µ</title>
    <meta name="keywords" content="ç•™è¨€æ¿,äº’åŠ¨äº¤æµ,å­¦ä¹ åˆ†äº«" />
    <meta name="description" content="é£ç¿”çš„ç¾Šç¾Šçš„ç•™è¨€æ¿ï¼Œæ¬¢è¿è®¿é—®ç•™è¨€äº¤æµ" />
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* å¤ç”¨ä¸»é¡µæ ¸å¿ƒæ ·å¼ï¼Œç¡®ä¿å¯¼èˆªæ ä¸€è‡´ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        a {
            text-decoration: none;
            color: inherit;
        }
        button {
            cursor: pointer;
            border: none;
            background: none;
        }
        /* å¯¼èˆªæ æ ·å¼ï¼ˆä¸ä¸»é¡µå®Œå…¨ä¸€è‡´ï¼‰ */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .nav-links {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .nav-links a {
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .nav-links a:hover {
            background-color: #34495e;
        }
        /* ç•™è¨€æ¿å…¥å£é«˜äº®ï¼ˆå½“å‰é¡µé¢ï¼‰ */
        .nav-links a.active {
            background-color: #3498db;
        }
        .auth-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .auth-btn {
            background-color: #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .auth-btn:hover {
            background-color: #2980b9;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }
        .user-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #3498db;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .user-avatar-small:hover {
            transform: scale(1.1);
        }
        .sign-btn {
            background-color: #e67e22;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .sign-btn:hover {
            background-color: #d35400;
        }
        .sign-btn.disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        /* ç•™è¨€æ¿ä¸»ä½“æ ·å¼ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .page-title {
            text-align: center;
            margin-bottom: 40px;
        }
        .page-title h2 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .page-title p {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }
        .divider {
            width: 80px;
            height: 3px;
            background-color: #3498db;
            margin: 15px auto 0;
        }
        /* ç•™è¨€è¡¨å•æ ·å¼ */
        .comment-form-container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 40px;
        }
        .form-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        .form-title i {
            color: #3498db;
            margin-right: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: #3498db;
        }
        .form-control:disabled {
            background-color: #f9f9f9;
            cursor: not-allowed;
        }
        textarea.form-control {
            min-height: 150px;
            resize: vertical;
        }
        .btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        .cancel-btn {
            background-color: #ecf0f1;
            color: #666;
            padding: 0.5rem 1.2rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .cancel-btn:hover {
            background-color: #e0e0e0;
        }
        .submit-btn {
            background-color: #3498db;
            color: white;
            padding: 0.5rem 1.2rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .submit-btn:hover {
            background-color: #2980b9;
        }
        .submit-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .auth-tip {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 12px 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            color: #2980b9;
        }
        .auth-tip i {
            margin-right: 10px;
        }
        /* ç•™è¨€åˆ—è¡¨æ ·å¼ */
        .message-list {
            margin-top: 40px;
        }
        .message-list h3 {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        .message-list h3 i {
            color: #3498db;
            margin-right: 10px;
        }
        .message-item {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .message-item:hover {
            transform: translateY(-3px);
        }
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .message-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid #ecf0f1;
        }
        .message-meta {
            flex: 1;
        }
        .message-author {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
        }
        .message-time {
            font-size: 0.9rem;
            color: #999;
        }
        .message-content {
            line-height: 1.8;
            color: #333;
            padding-left: 65px;
        }
        .no-message {
            text-align: center;
            padding: 60px 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            color: #999;
        }
        .no-message i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #eee;
        }
        .load-more {
            text-align: center;
            margin: 30px auto;
        }
        .load-more-btn {
            background-color: transparent;
            color: #3498db;
            border: 1px solid #3498db;
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .load-more-btn:hover {
            background-color: #3498db;
            color: white;
        }
        /* å“åº”å¼æ ·å¼ï¼ˆä¸ä¸»é¡µä¸€è‡´ï¼‰ */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 15px;
            }
            .nav-links, .auth-area {
                flex-wrap: wrap;
                justify-content: center;
            }
            .message-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .message-avatar {
                margin-bottom: 10px;
            }
            .message-content {
                padding-left: 0;
            }
            .btn-group {
                flex-direction: column;
            }
            .btn-group button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ ï¼ˆä¸ä¸»é¡µå®Œå…¨ä¸€è‡´ï¼‰ -->
    <header>
        <div class="nav-container">
            <div class="logo">æˆ‘çš„å­¦ä¹ ä¸»é¡µ</div>
            
            <!-- å¯¼èˆªé“¾æ¥åŒºåŸŸ -->
            <div class="nav-links">
                <a href="index.html">ä¸ªäººä»‹ç»</a>
                <a href="index.html#materials">å­¦ä¹ èµ„æ–™</a>
                <a href="index.html#contact">è”ç³»æ–¹å¼</a>
                <!-- ç•™è¨€æ¿å…¥å£ï¼ˆå½“å‰é¡µé¢é«˜äº®ï¼‰ -->
                <a href="message-board.html" class="active" style="display: flex; align-items: center;">
                    <<i class="fa fa-comments-o mr-1"></</i> ç•™è¨€æ¿
                </a>
                <a href="admin.html" id="admin-link" style="display: none;">ç®¡ç†å‘˜åå°</a>
            </div>
            
            <!-- ç™»å½•/ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
            <div class="auth-area">
                <!-- æœªç™»å½•æ˜¾ç¤ºç™»å½•å…¥å£ -->
                <div id="auth-entrance" style="display: block;">
                    <a href="login.html" class="auth-btn">ç™»å½•/æ³¨å†Œ</a>
                </div>
                <!-- ç™»å½•åæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ -->
                <div id="user-area" class="user-info" style="display: none;">
                    <img src="" alt="ç”¨æˆ·å¤´åƒ" class="user-avatar-small" id="nav-avatar">
                    <span>ğŸ‘¤ <span id="username">ç”¨æˆ·å</span></span>
                    <span>ç§¯åˆ†ï¼š<span id="points">0</span> âœ¨</span>
                    <button class="sign-btn" id="sign-btn">ä»Šæ—¥ç­¾åˆ°</button>
                    <button class="auth-btn" id="logout-btn">é€€å‡º</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ç•™è¨€æ¿ä¸»ä½“å†…å®¹ -->
    <div class="container">
        <div class="page-title">
            <h2>ç•™è¨€æ¿</h2>
            <p>æ¬¢è¿åœ¨è¿™é‡Œç•™ä¸‹ä½ çš„å­¦ä¹ å¿ƒå¾—ã€é—®é¢˜äº¤æµæˆ–å»ºè®®ï¼Œæˆ‘ä¼šåŠæ—¶å›å¤ï½</p>
            <div class="divider"></div>
        </div>

        <!-- ç•™è¨€è¡¨å• -->
        <div class="comment-form-container">
            <h3 class="form-title">
                <<i class="fa fa-pencil-square-o"></</i> å‘è¡¨ç•™è¨€
            </h3>
            <div class="auth-tip" id="auth-tip">
                <<i class="fa fa-info-circle"></</i>
                <span>è¯·å…ˆç™»å½•åå†å‘è¡¨ç•™è¨€ï¼Œæœªç™»å½•ç”¨æˆ·åªèƒ½æŸ¥çœ‹ç•™è¨€ã€‚</span>
            </div>
            <form id="comment-form">
                <div class="form-group">
                    <label for="author">æ˜µç§°</label>
                    <input type="text" id="author" name="author" class="form-control" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" disabled>
                </div>
                <div class="form-group">
                    <label for="email">é‚®ç®±</label>
                    <input type="email" id="email" name="email" class="form-control" placeholder="è¯·è¾“å…¥ä½ çš„é‚®ç®±" disabled readonly>
                </div>
                <div class="form-group">
                    <label for="content">ç•™è¨€å†…å®¹</label>
                    <textarea id="content" name="content" class="form-control" placeholder="è¯´ç‚¹ä»€ä¹ˆå§ï½" disabled></textarea>
                </div>
                <div class="btn-group">
                    <button type="button" class="cancel-btn" id="cancel-btn" disabled>å–æ¶ˆ</button>
                    <button type="submit" class="submit-btn" id="submit-btn" disabled>å‘é€ç•™è¨€</button>
                </div>
            </form>
        </div>

        <!-- ç•™è¨€åˆ—è¡¨ -->
        <div class="message-list">
            <h3><<i class="fa fa-comments-o"></</i> æœ€æ–°ç•™è¨€</h3>
            <div id="message-container">
                <!-- ç©ºçŠ¶æ€ -->
                <div class="no-message">
                    <<i class="fa fa-comment-o"></</i>
                    <p>æš‚æ— ç•™è¨€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡ç•™è¨€å§ï½</p>
                </div>
            </div>
            <!-- åŠ è½½æ›´å¤š -->
            <div class="load-more" id="load-more" style="display: none;">
                <button class="load-more-btn" id="load-more-btn">åŠ è½½æ›´å¤š</button>
            </div>
        </div>
    </div>

    <!-- é¡µè„šï¼ˆä¸ä¸»é¡µä¸€è‡´ï¼‰ -->
    <footer style="background-color: #2c3e50; color: white; text-align: center; padding: 2rem 0; margin-top: 40px;">
        <p>Â© 2025 æˆ‘çš„ä¸ªäººå­¦ä¹ ä¸»é¡µ | å¤§å­¦ç”Ÿå­¦ä¹ åˆ†äº«å¹³å°</p>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">æ„¿æˆ‘ä»¬éƒ½åœ¨å­¦ä¹ çš„è·¯ä¸Šä¸æ–­è¿›æ­¥ï½</p>
    </footer>

    <script>
        // Supabaseæ ¸å¿ƒé…ç½®ï¼ˆä¸ä¸»é¡µä¸€è‡´ï¼‰
        const SUPABASE_URL = 'https://neflfdfpzyjookonmleo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZmxmZGZwenlqb29rb25tbGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNzQxMTUsImV4cCI6MjA4MDk1MDExNX0.z944F1VmJO9ro-1iDtB9HD_1NVThzz7mzqSX0IQqj68';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // å…¨å±€çŠ¶æ€
        let currentUser = null;
        let messages = [];
        let page = 1;
        const pageSize = 10;

        // DOMå…ƒç´ 
        const authEntrance = document.getElementById('auth-entrance');
        const userArea = document.getElementById('user-area');
        const navAvatar = document.getElementById('nav-avatar');
        const usernameEl = document.getElementById('username');
        const pointsEl = document.getElementById('points');
        const signBtn = document.getElementById('sign-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authTip = document.getElementById('auth-tip');
        const commentForm = document.getElementById('comment-form');
        const authorInput = document.getElementById('author');
        const emailInput = document.getElementById('email');
        const contentInput = document.getElementById('content');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const messageContainer = document.getElementById('message-container');
        const loadMore = document.getElementById('load-more');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const adminLink = document.getElementById('admin-link');

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = async function() {
            await checkLoginStatus(); // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆä¸ä¸»é¡µé€»è¾‘ä¸€è‡´ï¼‰
            bindLogoutEvent(); // ç»‘å®šé€€å‡ºäº‹ä»¶
            bindSignEvent(); // ç»‘å®šç­¾åˆ°äº‹ä»¶
            bindFormEvents(); // ç»‘å®šç•™è¨€è¡¨å•äº‹ä»¶
            await fetchMessages(); // åŠ è½½ç•™è¨€
        };

        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆå¤ç”¨ä¸»é¡µé€»è¾‘ï¼‰
        async function checkLoginStatus() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                currentUser = session?.user || null;

                if (currentUser) {
                    // å·²ç™»å½•çŠ¶æ€
                    authEntrance.style.display = 'none';
                    userArea.style.display = 'flex';
                    await renderUserInfo(currentUser.id, currentUser.email);
                    await checkSignStatus();
                    updateFormStatus(true); // å¯ç”¨è¡¨å•
                    
                    // ç®¡ç†å‘˜æƒé™åˆ¤æ–­ï¼ˆå¯é€‰ï¼‰
                    const { data: user } = await supabase
                        .from('users')
                        .select('role')
                        .eq('id', currentUser.id)
                        .single();
                    if (user?.role === 'admin') {
                        adminLink.style.display = 'block';
                    }
                } else {
                    // æœªç™»å½•çŠ¶æ€
                    authEntrance.style.display = 'block';
                    userArea.style.display = 'none';
                    updateFormStatus(false); // ç¦ç”¨è¡¨å•
                }
            } catch (err) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥ï¼š', err);
                alert('ç™»å½•çŠ¶æ€æ£€æµ‹å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        }

        // æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯ï¼ˆå¤ç”¨ä¸»é¡µé€»è¾‘ï¼Œå«å¤´åƒï¼‰
        async function renderUserInfo(userId, userEmail) {
            try {
                const { data: userProfile } = await supabase
                    .from('users')
                    .select('username, points')
                    .eq('id', userId)
                    .single();

                usernameEl.textContent = userProfile?.username || 'æœªçŸ¥ç”¨æˆ·';
                pointsEl.textContent = userProfile?.points || 0;

                // åŠ è½½QQå¤´åƒ
                if (userEmail && userEmail.includes('@qq.com')) {
                    const qqNumber = userEmail.split('@')[0];
                    const avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${qqNumber}&s=640`;
                    navAvatar.src = avatarUrl;
                    navAvatar.alt = `${usernameEl.textContent}çš„å¤´åƒ`;
                }
            } catch (err) {
                console.error('æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š', err);
                usernameEl.textContent = 'æœªçŸ¥ç”¨æˆ·';
            }
        }

        // æ£€æŸ¥ç­¾åˆ°çŠ¶æ€ï¼ˆå¤ç”¨ä¸»é¡µé€»è¾‘ï¼‰
        async function checkSignStatus() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const { data: signRecord } = await supabase
                    .from('sign_records')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('sign_date', today)
                    .single();

                if (signRecord) {
                    signBtn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
                    signBtn.classList.add('disabled');
                    signBtn.disabled = true;
                } else {
                    signBtn.textContent = 'ä»Šæ—¥ç­¾åˆ°';
                    signBtn.classList.remove('disabled');
                    signBtn.disabled = false;
                }
            } catch (err) {
                signBtn.textContent = 'ä»Šæ—¥ç­¾åˆ°';
                signBtn.classList.remove('disabled');
                signBtn.disabled = false;
            }
        }

        // ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶ï¼ˆå¤ç”¨ä¸»é¡µé€»è¾‘ï¼‰
        function bindLogoutEvent() {
            logoutBtn.onclick = async function() {
                try {
                    await supabase.auth.signOut();
                    alert('é€€å‡ºç™»å½•æˆåŠŸï¼');
                    window.location.reload();
                } catch (err) {
                    alert('é€€å‡ºç™»å½•å¤±è´¥ï¼š' + err.message);
                }
            };
        }

        // ç»‘å®šç­¾åˆ°äº‹ä»¶ï¼ˆå¤ç”¨ä¸»é¡µé€»è¾‘ï¼‰
        function bindSignEvent() {
            signBtn.onclick = async function() {
                try {
                    signBtn.disabled = true;
                    signBtn.textContent = 'ç­¾åˆ°ä¸­...';

                    const { data: userProfile } = await supabase
                        .from('users')
                        .select('points')
                        .eq('id', currentUser.id)
                        .single();

                    const currentPoints = userProfile?.points || 0;
                    const addPoints = 10;
                    const newPoints = currentPoints + addPoints;

                    // æ›´æ–°ç§¯åˆ†
                    await supabase
                        .from('users')
                        .update({ points: newPoints })
                        .eq('id', currentUser.id);

                    // è®°å½•ç­¾åˆ°
                    const today = new Date().toISOString().split('T')[0];
                    await supabase.from('sign_records').insert([{
                        user_id: currentUser.id,
                        sign_date: today,
                        points: addPoints
                    }]);

                    // æ›´æ–°é¡µé¢
                    pointsEl.textContent = newPoints;
                    signBtn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
                    signBtn.classList.add('disabled');
                    alert(`ç­¾åˆ°æˆåŠŸï¼è·å¾—${addPoints}ç§¯åˆ†ï¼Œå½“å‰ç§¯åˆ†ï¼š${newPoints}`);
                } catch (err) {
                    alert('ç­¾åˆ°å¤±è´¥ï¼š' + err.message);
                    signBtn.textContent = 'ä»Šæ—¥ç­¾åˆ°';
                    signBtn.disabled = false;
                }
            };
        }

        // æ›´æ–°è¡¨å•çŠ¶æ€ï¼ˆç™»å½•/æœªç™»å½•åˆ‡æ¢ï¼‰
        function updateFormStatus(isEnabled) {
            authorInput.disabled = !isEnabled;
            emailInput.disabled = !isEnabled;
            contentInput.disabled = !isEnabled;
            submitBtn.disabled = !isEnabled;
            cancelBtn.disabled = !isEnabled;

            if (isEnabled) {
                // å·²ç™»å½•ï¼šå¯ç”¨è¡¨å•
                authorInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                emailInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                contentInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                submitBtn.classList.remove('bg-gray-300', 'text-gray-500');
                authTip.innerHTML = `<<i class="fa fa-user"></</i><span>ä½ å·²ç™»å½•ï¼š${currentUser.email}ï¼Œå¯ä»¥å‘è¡¨ç•™è¨€å•¦ï½</span>`;
                // å¡«å……é‚®ç®±
                emailInput.value = currentUser.email;
            } else {
                // æœªç™»å½•ï¼šç¦ç”¨è¡¨å•
                authorInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                emailInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                contentInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                submitBtn.classList.add('bg-gray-300', 'text-gray-500');
                authTip.innerHTML = `<<i class="fa fa-info-circle"></</i><span>è¯·å…ˆç™»å½•åå†å‘è¡¨ç•™è¨€ï¼Œæœªç™»å½•ç”¨æˆ·åªèƒ½æŸ¥çœ‹ç•™è¨€ã€‚</span>`;
            }
        }

        // ç»‘å®šç•™è¨€è¡¨å•äº‹ä»¶
        function bindFormEvents() {
            // è¡¨å•æäº¤
            commentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return;

                const author = authorInput.value.trim();
                const content = contentInput.value.trim();
                if (!author || !content) {
                    alert('æ˜µç§°å’Œç•™è¨€å†…å®¹ä¸èƒ½ä¸ºç©º');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'æäº¤ä¸­...';

                try {
                    // æäº¤ç•™è¨€åˆ°Supabase
                    const { data, error } = await supabase
                        .from('messages')
                        .insert([{
                            user_id: currentUser.id,
                            author: author,
                            email: currentUser.email,
                            content: content,
                            created_at: new Date().toISOString()
                        }])
                        .select();

                    if (error) throw new Error(error.message);

                    // é‡ç½®è¡¨å•+åˆ·æ–°ç•™è¨€
                    commentForm.reset();
                    await fetchMessages(true);
                    alert('ç•™è¨€æäº¤æˆåŠŸï¼');
                } catch (err) {
                    alert('ç•™è¨€æäº¤å¤±è´¥ï¼š' + err.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'å‘é€ç•™è¨€';
                }
            });

            // å–æ¶ˆæŒ‰é’®
            cancelBtn.addEventListener('click', () => {
                commentForm.reset();
            });

            // åŠ è½½æ›´å¤š
            loadMoreBtn.addEventListener('click', async () => {
                page++;
                await fetchMessages(false);
            });
        }

        // åŠ è½½ç•™è¨€åˆ—è¡¨
        async function fetchMessages(forceRefresh = false) {
            if (forceRefresh) {
                page = 1;
                messages = [];
            }

            try {
                const { data, error, count } = await supabase
                    .from('messages')
                    .select('*', { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .range((page - 1) * pageSize, page * pageSize - 1);

                if (error) throw new Error(error.message);

                // æ›´æ–°ç•™è¨€æ•°æ®
                messages = forceRefresh ? data : [...messages, ...data];

                // æ¸²æŸ“ç•™è¨€
                if (messages.length === 0) {
                    messageContainer.innerHTML = `
                        <div class="no-message">
                            <<i class="fa fa-comment-o"></</i>
                            <p>æš‚æ— ç•™è¨€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡ç•™è¨€å§ï½</p>
                        </div>
                    `;
                    loadMore.style.display = 'none';
                    return;
                }

                // æ¸²æŸ“ç•™è¨€é¡¹
                messageContainer.innerHTML = messages.map(msg => {
                    const qqNumber = msg.email.includes('@qq.com') ? msg.email.split('@')[0] : '';
                    const avatarUrl = qqNumber ? `https://q1.qlogo.cn/g?b=qq&nk=${qqNumber}&s=640` : 'https://q1.qlogo.cn/g?b=qq&nk=0&s=640';
                    const formatTime = (timeStr) => {
                        return new Date(timeStr).toLocaleString('zh-CN', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        });
                    };

                    return `
                        <div class="message-item">
                            <div class="message-header">
                                <img src="${avatarUrl}" alt="${msg.author}çš„å¤´åƒ" class="message-avatar">
                                <div class="message-meta">
                                    <div class="message-author">${msg.author}</div>
                                    <div class="message-time">${formatTime(msg.created_at)} Â· ${msg.email}</div>
                                </div>
                            </div>
                            <div class="message-content">${msg.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }).join('');

                // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤š
                loadMore.style.display = messages.length >= count ? 'none' : 'block';
            } catch (err) {
                messageContainer.innerHTML = `
                    <div class="no-message">
                        <<i class="fa fa-exclamation-circle" style="color: #e74c3c;"></</i>
                        <p>åŠ è½½ç•™è¨€å¤±è´¥ï¼š${err.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
